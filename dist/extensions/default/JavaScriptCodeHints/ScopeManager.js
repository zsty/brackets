define(function(require,exports,module){"use strict";var _=brackets.getModule("thirdparty/lodash");var CodeMirror=brackets.getModule("thirdparty/CodeMirror2/lib/codemirror"),DefaultDialogs=brackets.getModule("widgets/DefaultDialogs"),Dialogs=brackets.getModule("widgets/Dialogs"),DocumentManager=brackets.getModule("document/DocumentManager"),EditorManager=brackets.getModule("editor/EditorManager"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),FileSystem=brackets.getModule("filesystem/FileSystem"),FileUtils=brackets.getModule("file/FileUtils"),LanguageManager=brackets.getModule("language/LanguageManager"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),ProjectManager=brackets.getModule("project/ProjectManager"),Strings=brackets.getModule("strings"),StringUtils=brackets.getModule("utils/StringUtils");var HintUtils=require("HintUtils"),MessageIds=require("MessageIds"),Preferences=require("Preferences");var ternEnvironment=[],pendingTernRequests={},builtinFiles=["ecma5.json","browser.json","jquery.json"],builtinLibraryNames=[],isDocumentDirty=false,_hintCount=0,currentWorker=null,documentChanges=null,preferences=null,deferredPreferences=null;var MAX_HINTS=30,LARGE_LINE_CHANGE=100,LARGE_LINE_COUNT=1e4,OFFSET_ZERO={line:0,ch:0};var config={};function getBuiltins(){return builtinLibraryNames}function initTernEnv(){var path=ExtensionUtils.getModulePath(module,"thirdparty/tern/defs/"),files=builtinFiles,library;files.forEach(function(i){FileSystem.resolve(path+i,function(err,file){if(!err){FileUtils.readAsText(file).done(function(text){library=JSON.parse(text);builtinLibraryNames.push(library["!name"]);ternEnvironment.push(library)}).fail(function(error){console.log("failed to read tern config file "+i)})}else{console.log("failed to read tern config file "+i)}})})}initTernEnv();function initPreferences(projectRootPath){if(deferredPreferences&&deferredPreferences.state()==="pending"){deferredPreferences.reject()}deferredPreferences=$.Deferred();var pr=ProjectManager.getProjectRoot();if(pr){projectRootPath=pr.fullPath}else if(!projectRootPath){console.log("initPreferences: projectRootPath has no value")}var path=projectRootPath+Preferences.FILE_NAME;FileSystem.resolve(path,function(err,file){if(!err){FileUtils.readAsText(file).done(function(text){var configObj=null;try{configObj=JSON.parse(text)}catch(e){console.log("Error parsing preference file: "+path);if(e instanceof SyntaxError){console.log(e.message)}}preferences=new Preferences(configObj);deferredPreferences.resolve()}).fail(function(error){preferences=new Preferences;deferredPreferences.resolve()})}else{preferences=new Preferences;deferredPreferences.resolve()}})}function ensurePreferences(){if(!deferredPreferences){initPreferences()}}function postMessage(msg){if(currentWorker){currentWorker.postMessage(msg)}}function isDirectoryExcluded(path){var excludes=preferences.getExcludedDirectories();if(!excludes){return false}var testPath=ProjectManager.makeProjectRelativeIfPossible(path);testPath=FileUtils.stripTrailingSlash(testPath);return excludes.test(testPath)}function isFileBeingEdited(filePath){var currentEditor=EditorManager.getActiveEditor(),currentDoc=currentEditor&&currentEditor.document;return currentDoc&&currentDoc.file.fullPath===filePath}function isFileExcludedInternal(path){var detectedExclusions=PreferencesManager.get("jscodehints.detectedExclusions")||[];if(detectedExclusions&&detectedExclusions.indexOf(path)!==-1){return true}return false}function isFileExcluded(file){if(file.name[0]==="."){return true}var languageID=LanguageManager.getLanguageForPath(file.fullPath).getId();if(languageID!==HintUtils.LANGUAGE_ID){return true}var excludes=preferences.getExcludedFiles();if(excludes&&excludes.test(file.name)){return true}if(isFileExcludedInternal(file.fullPath)){return true}return false}function addPendingRequest(file,offset,type){var requests,key=file+"@"+offset.line+"@"+offset.ch,$deferredRequest;if(isFileExcludedInternal(file)){return(new $.Deferred).reject().promise()}if(_.has(pendingTernRequests,key)){requests=pendingTernRequests[key]}else{requests={};pendingTernRequests[key]=requests}if(_.has(requests,type)){$deferredRequest=requests[type]}else{requests[type]=$deferredRequest=new $.Deferred}return $deferredRequest.promise()}function getPendingRequest(file,offset,type){var key=file+"@"+offset.line+"@"+offset.ch;if(_.has(pendingTernRequests,key)){var requests=pendingTernRequests[key],requestType=requests[type];delete pendingTernRequests[key][type];if(!Object.keys(requests).length){delete pendingTernRequests[key]}return requestType}}function getResolvedPath(file){return currentWorker.getResolvedPath(file)}function getJumptoDef(fileInfo,offset){postMessage({type:MessageIds.TERN_JUMPTODEF_MSG,fileInfo:fileInfo,offset:offset});return addPendingRequest(fileInfo.name,offset,MessageIds.TERN_JUMPTODEF_MSG)}function filterText(text){var newText=text;if(text.length>preferences.getMaxFileSize()){newText=""}return newText}function getTextFromDocument(document){var text=document.getText();text=filterText(text);return text}function requestJumptoDef(session,document,offset){var path=document.file.fullPath,fileInfo={type:MessageIds.TERN_FILE_INFO_TYPE_FULL,name:path,offsetLines:0,text:filterText(session.getJavascriptText())};var ternPromise=getJumptoDef(fileInfo,offset);return{promise:ternPromise}}function handleJumptoDef(response){var file=response.file,offset=response.offset;var $deferredJump=getPendingRequest(file,offset,MessageIds.TERN_JUMPTODEF_MSG);if($deferredJump){response.fullPath=getResolvedPath(response.resultFile);$deferredJump.resolveWith(null,[response])}}function getTernHints(fileInfo,offset,isProperty){postMessage({type:MessageIds.TERN_COMPLETIONS_MSG,fileInfo:fileInfo,offset:offset,isProperty:isProperty});return addPendingRequest(fileInfo.name,offset,MessageIds.TERN_COMPLETIONS_MSG)}function getTernFunctionType(fileInfo,offset){postMessage({type:MessageIds.TERN_CALLED_FUNC_TYPE_MSG,fileInfo:fileInfo,offset:offset});return addPendingRequest(fileInfo.name,offset,MessageIds.TERN_CALLED_FUNC_TYPE_MSG)}function getFragmentAround(session,start){var minIndent=null,minLine=null,endLine,cm=session.editor._codeMirror,tabSize=cm.getOption("tabSize"),document=session.editor.document,p,min,indent,line;for(p=start.line-1,min=Math.max(0,p-100);p>=min;--p){line=session.getLine(p);var fn=line.search(/\bfunction\b/);if(fn>=0){indent=CodeMirror.countColumn(line,null,tabSize);if(minIndent===null||minIndent>indent){if(session.getToken({line:p,ch:fn+1}).type==="keyword"){minIndent=indent;minLine=p}}}}if(minIndent===null){minIndent=0}if(minLine===null){minLine=min}var max=Math.min(cm.lastLine(),start.line+100),endCh=0;for(endLine=start.line+1;endLine<max;++endLine){line=cm.getLine(endLine);if(line.length>0){indent=CodeMirror.countColumn(line,null,tabSize);if(indent<=minIndent){endCh=line.length;break}}}var from={line:minLine,ch:0},to={line:endLine,ch:endCh};return{type:MessageIds.TERN_FILE_INFO_TYPE_PART,name:document.file.fullPath,offsetLines:from.line,text:document.getRange(from,to)}}function getFileInfo(session,preventPartialUpdates){var start=session.getCursor(),end=start,document=session.editor.document,path=document.file.fullPath,isHtmlFile=LanguageManager.getLanguageForPath(path).getId()==="html",result;if(isHtmlFile){result={type:MessageIds.TERN_FILE_INFO_TYPE_FULL,name:path,text:session.getJavascriptText()}}else if(!documentChanges){result={type:MessageIds.TERN_FILE_INFO_TYPE_EMPTY,name:path,text:""}}else if(!preventPartialUpdates&&session.editor.lineCount()>LARGE_LINE_COUNT&&documentChanges.to-documentChanges.from<LARGE_LINE_CHANGE&&documentChanges.from<=start.line&&documentChanges.to>end.line){result=getFragmentAround(session,start)}else{result={type:MessageIds.TERN_FILE_INFO_TYPE_FULL,name:path,text:getTextFromDocument(document)}}documentChanges=null;return result}function getOffset(session,fileInfo,offset){var newOffset;if(offset){newOffset={line:offset.line,ch:offset.ch}}else{newOffset=session.getCursor()}if(fileInfo.type===MessageIds.TERN_FILE_INFO_TYPE_PART){newOffset.line=Math.max(0,newOffset.line-fileInfo.offsetLines)}return newOffset}function requestGuesses(session,document){var $deferred=$.Deferred(),fileInfo=getFileInfo(session),offset=getOffset(session,fileInfo);postMessage({type:MessageIds.TERN_GET_GUESSES_MSG,fileInfo:fileInfo,offset:offset});var promise=addPendingRequest(fileInfo.name,offset,MessageIds.TERN_GET_GUESSES_MSG);promise.done(function(guesses){session.setGuesses(guesses);$deferred.resolve()}).fail(function(){$deferred.reject()});return $deferred.promise()}function handleTernCompletions(response){var file=response.file,offset=response.offset,completions=response.completions,properties=response.properties,fnType=response.fnType,type=response.type,error=response.error,$deferredHints=getPendingRequest(file,offset,type);if($deferredHints){if(error){$deferredHints.reject()}else if(completions){$deferredHints.resolveWith(null,[{completions:completions}])}else if(properties){$deferredHints.resolveWith(null,[{properties:properties}])}else if(fnType){$deferredHints.resolveWith(null,[fnType])}}}function handleGetGuesses(response){var path=response.file,type=response.type,offset=response.offset,$deferredHints=getPendingRequest(path,offset,type);if($deferredHints){$deferredHints.resolveWith(null,[response.properties])}}function handleUpdateFile(response){var path=response.path,type=response.type,$deferredHints=getPendingRequest(path,OFFSET_ZERO,type);if($deferredHints){$deferredHints.resolve()}}function handleTimedOut(response){var detectedExclusions=PreferencesManager.get("jscodehints.detectedExclusions")||[],filePath=response.file;if(isFileBeingEdited(filePath)){return}if(detectedExclusions.indexOf(filePath)!==-1){console.log("JavaScriptCodeHints.handleTimedOut: file already in detectedExclusions array timed out: "+filePath);return}detectedExclusions.push(filePath);PreferencesManager.set("jscodehints.detectedExclusions",detectedExclusions,{location:{scope:"project"}});Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_INFO,Strings.DETECTED_EXCLUSION_TITLE,StringUtils.format(Strings.DETECTED_EXCLUSION_INFO,StringUtils.breakableUrl(filePath)),[{className:Dialogs.DIALOG_BTN_CLASS_PRIMARY,id:Dialogs.DIALOG_BTN_OK,text:Strings.OK}])}function TernWorker(){var ternPromise=null,addFilesPromise=null,rootTernDir=null,projectRoot=null,stopAddingFiles=false,resolvedFiles={},numInitialFiles=0,numResolvedFiles=0,numAddedFiles=0,_ternWorker=null;function getResolvedPath(file){return resolvedFiles[file]}function usingModules(){return numInitialFiles!==numResolvedFiles}function postMessage(msg){addFilesPromise.done(function(ternWorker){if(!ternWorker){return}if(config.debug){console.debug("Sending message",msg)}ternWorker.postMessage(msg)})}function _postMessageByPass(msg){ternPromise.done(function(ternWorker){if(config.debug){console.debug("Sending message",msg)}ternWorker.postMessage(msg)})}function updateTernFile(document){var path=document.file.fullPath;_postMessageByPass({type:MessageIds.TERN_UPDATE_FILE_MSG,path:path,text:getTextFromDocument(document)});return addPendingRequest(path,OFFSET_ZERO,MessageIds.TERN_UPDATE_FILE_MSG)}function handleTernGetFile(request){function replyWith(name,txt){_postMessageByPass({type:MessageIds.TERN_GET_FILE_MSG,file:name,text:txt})}var name=request.file;function getDocText(filePath){if(!FileSystem.isAbsolutePath(filePath)){return(new $.Deferred).reject().promise()}var file=FileSystem.getFileForPath(filePath),promise=DocumentManager.getDocumentText(file);promise.done(function(docText){resolvedFiles[name]=filePath;numResolvedFiles++;replyWith(name,filterText(docText))});return promise}function findNameInProject(){var fileName=name.substring(name.lastIndexOf("/")+1);function _fileFilter(entry){return entry.name===fileName}ProjectManager.getAllFiles(_fileFilter).done(function(files){var file;files=files.filter(function(file){var pos=file.fullPath.length-name.length;return pos===file.fullPath.lastIndexOf(name)});if(files.length===1){file=files[0]}if(file){getDocText(file.fullPath).fail(function(){replyWith(name,"")})}else{replyWith(name,"")}})}if(!isFileExcludedInternal(name)){getDocText(name).fail(function(){getDocText(rootTernDir+name).fail(function(){getDocText(projectRoot+name).fail(findNameInProject)})})}}function primePump(path){_postMessageByPass({type:MessageIds.TERN_PRIME_PUMP_MSG,path:path});return addPendingRequest(path,OFFSET_ZERO,MessageIds.TERN_PRIME_PUMP_MSG)}function handlePrimePumpCompletion(response){var path=response.path,type=response.type,$deferredHints=getPendingRequest(path,OFFSET_ZERO,type);if($deferredHints){$deferredHints.resolve()}}function addFilesToTern(files){var maxFileCount=preferences.getMaxFileCount();if(numResolvedFiles+numAddedFiles<maxFileCount){var available=maxFileCount-numResolvedFiles-numAddedFiles;if(available<files.length){files=files.slice(0,available)}numAddedFiles+=files.length;ternPromise.done(function(worker){var msg={type:MessageIds.TERN_ADD_FILES_MSG,files:files};if(config.debug){console.debug("Sending message",msg)}worker.postMessage(msg)})}else{stopAddingFiles=true}return stopAddingFiles}function addAllFilesAndSubdirectories(dir,doneCallback){FileSystem.resolve(dir,function(err,directory){function visitor(entry){if(entry.isFile){if(!isFileExcluded(entry)){addFilesToTern([entry.fullPath])}}else{return!isDirectoryExcluded(entry.fullPath)&&entry.name.indexOf(".")!==0&&!stopAddingFiles}}if(err){return}if(dir===FileSystem.getDirectoryForPath(rootTernDir)){doneCallback();return}directory.visit(visitor,doneCallback)})}function initTernWorker(){if(_ternWorker){_ternWorker.terminate()}var workerDeferred=$.Deferred();ternPromise=workerDeferred.promise();var path=ExtensionUtils.getModulePath(module,"tern-worker.js");_ternWorker=new Worker(path);_ternWorker.addEventListener("message",function(e){if(config.debug){console.debug("Message received",e)}var response=e.data,type=response.type;if(type===MessageIds.TERN_COMPLETIONS_MSG||type===MessageIds.TERN_CALLED_FUNC_TYPE_MSG){handleTernCompletions(response)}else if(type===MessageIds.TERN_GET_FILE_MSG){handleTernGetFile(response)}else if(type===MessageIds.TERN_JUMPTODEF_MSG){handleJumptoDef(response)}else if(type===MessageIds.TERN_PRIME_PUMP_MSG){handlePrimePumpCompletion(response)}else if(type===MessageIds.TERN_GET_GUESSES_MSG){handleGetGuesses(response)}else if(type===MessageIds.TERN_UPDATE_FILE_MSG){handleUpdateFile(response)}else if(type===MessageIds.TERN_INFERENCE_TIMEDOUT){handleTimedOut(response)}else if(type===MessageIds.TERN_WORKER_READY){workerDeferred.resolveWith(null,[_ternWorker])}else{console.log("Worker: "+(response.log||response))}});_ternWorker.postMessage({type:MessageIds.SET_CONFIG,config:config})}function initTernServer(dir,files){initTernWorker();numResolvedFiles=0;numAddedFiles=0;stopAddingFiles=false;numInitialFiles=files.length;ternPromise.done(function(worker){var msg={type:MessageIds.TERN_INIT_MSG,dir:dir,files:files,env:ternEnvironment,timeout:PreferencesManager.get("jscodehints.inferenceTimeout")};if(worker){if(config.debug){console.debug("Sending message",msg)}worker.postMessage(msg)}else{if(config.debug){console.debug("Worker null. Cannot send message",msg)}}});rootTernDir=dir+"/"}function canSkipTernInitialization(newFile){return resolvedFiles[newFile]!==undefined}function doEditorChange(session,document,previousDocument){var file=document.file,path=file.fullPath,dir=file.parentPath,pr;var addFilesDeferred=$.Deferred();documentChanges=null;addFilesPromise=addFilesDeferred.promise();pr=ProjectManager.getProjectRoot()?ProjectManager.getProjectRoot().fullPath:null;if(canSkipTernInitialization(path)){if(isDocumentDirty&&previousDocument){var updateFilePromise=updateTernFile(previousDocument);updateFilePromise.done(function(){primePump(path);addFilesDeferred.resolveWith(null,[_ternWorker])})}else{addFilesDeferred.resolveWith(null,[_ternWorker])}isDocumentDirty=false;return}isDocumentDirty=false;resolvedFiles={};projectRoot=pr;ensurePreferences();deferredPreferences.done(function(){FileSystem.resolve(dir,function(err,directory){if(err){console.error("Error resolving",dir);addFilesDeferred.resolveWith(null);return}directory.getContents(function(err,contents){if(err){console.error("Error getting contents for",directory);addFilesDeferred.resolveWith(null);return}var files=contents.filter(function(entry){return entry.isFile&&!isFileExcluded(entry)}).map(function(entry){return entry.fullPath});initTernServer(dir,files);var hintsPromise=primePump(path);hintsPromise.done(function(){if(!usingModules()){addAllFilesAndSubdirectories(dir,function(){var currentDir=dir+"/";if(projectRoot&&currentDir!==projectRoot&&currentDir.indexOf(projectRoot)===0){addAllFilesAndSubdirectories(projectRoot,function(){primePump(path);addFilesDeferred.resolveWith(null,[_ternWorker])})}else{addFilesDeferred.resolveWith(null,[_ternWorker])}})}else{addFilesDeferred.resolveWith(null,[_ternWorker])}})})})})}function handleEditorChange(session,document,previousDocument){if(addFilesPromise===null){doEditorChange(session,document,previousDocument)}else{addFilesPromise.done(function(){doEditorChange(session,document,previousDocument)})}}function closeWorker(){function terminateWorker(){var worker=_ternWorker;if(!worker){return}setTimeout(function(){worker.terminate();worker=null},1e3);_ternWorker=null;resolvedFiles={}}if(_ternWorker){if(addFilesPromise){addFilesPromise.done(terminateWorker).fail(terminateWorker)}else{terminateWorker()}}}function whenReady(func){addFilesPromise.done(func)}this.closeWorker=closeWorker;this.handleEditorChange=handleEditorChange;this.postMessage=postMessage;this.getResolvedPath=getResolvedPath;this.whenReady=whenReady;return this}var resettingDeferred=null;function _maybeReset(session,document,force){var newWorker;if(!resettingDeferred){if(force||!config.noReset&&++_hintCount>MAX_HINTS){if(config.debug){console.debug("Resetting tern worker")}resettingDeferred=new $.Deferred;newWorker=new TernWorker;newWorker.handleEditorChange(session,document,null);newWorker.whenReady(function(){currentWorker.closeWorker();currentWorker=newWorker;resettingDeferred.resolve(currentWorker);resettingDeferred=null});_hintCount=0}else{var d=new $.Deferred;d.resolve(currentWorker);return d.promise()}}return resettingDeferred.promise()}function requestParameterHint(session,functionOffset){var $deferredHints=$.Deferred(),fileInfo=getFileInfo(session,true),offset=getOffset(session,fileInfo,functionOffset),fnTypePromise=getTernFunctionType(fileInfo,offset);$.when(fnTypePromise).done(function(fnType){session.setFnType(fnType);session.setFunctionCallPos(functionOffset);$deferredHints.resolveWith(null,[fnType])}).fail(function(){$deferredHints.reject()});return $deferredHints.promise()}function requestHints(session,document){var $deferredHints=$.Deferred(),hintPromise,sessionType=session.getType(),fileInfo=getFileInfo(session),offset=getOffset(session,fileInfo,null);_maybeReset(session,document);hintPromise=getTernHints(fileInfo,offset,sessionType.property);$.when(hintPromise).done(function(completions,fnType){if(completions.completions){session.setTernHints(completions.completions);session.setGuesses(null)}else{session.setTernHints([]);session.setGuesses(completions.properties)}$deferredHints.resolveWith(null)}).fail(function(){$deferredHints.reject()});return $deferredHints.promise()}function trackChange(changeList){var changed=documentChanges,i;if(changed===null){documentChanges=changed={from:changeList[0].from.line,to:changeList[0].from.line};if(config.debug){console.debug("ScopeManager: document has changed")}}for(i=0;i<changeList.length;i++){var thisChange=changeList[i],end=thisChange.from.line+(thisChange.text.length-1);if(thisChange.from.line<changed.to){changed.to=changed.to-(thisChange.to.line-end)}if(end>=changed.to){changed.to=end+1}if(changed.from>thisChange.from.line){changed.from=thisChange.from.line}}}function handleFileChange(changeList){isDocumentDirty=true;trackChange(changeList)}function handleEditorChange(session,document,previousDocument){if(!currentWorker){currentWorker=new TernWorker}return currentWorker.handleEditorChange(session,document,previousDocument)}function handleProjectClose(){if(currentWorker){currentWorker.closeWorker();currentWorker=null}}function handleProjectOpen(projectRootPath){initPreferences(projectRootPath)}function _readyPromise(){return deferredPreferences}function _setConfig(configUpdate){config=brackets._configureJSCodeHints.config;postMessage({type:MessageIds.SET_CONFIG,config:configUpdate})}exports._setConfig=_setConfig;exports._maybeReset=_maybeReset;exports.getBuiltins=getBuiltins;exports.getResolvedPath=getResolvedPath;exports.getTernHints=getTernHints;exports.handleEditorChange=handleEditorChange;exports.requestGuesses=requestGuesses;exports.handleFileChange=handleFileChange;exports.requestHints=requestHints;exports.requestJumptoDef=requestJumptoDef;exports.requestParameterHint=requestParameterHint;exports.handleProjectClose=handleProjectClose;exports.handleProjectOpen=handleProjectOpen;exports._readyPromise=_readyPromise});