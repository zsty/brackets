define(function(require,exports,module){"use strict";var CodeMirror=brackets.getModule("thirdparty/CodeMirror2/lib/codemirror"),Strings=brackets.getModule("strings"),AppInit=brackets.getModule("utils/AppInit"),CommandManager=brackets.getModule("command/CommandManager"),DocumentManager=brackets.getModule("document/DocumentManager"),Editor=brackets.getModule("editor/Editor").Editor,EditorManager=brackets.getModule("editor/EditorManager"),ProjectManager=brackets.getModule("project/ProjectManager"),KeyBindingManager=brackets.getModule("command/KeyBindingManager"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),Menus=brackets.getModule("command/Menus"),prefs=require("Prefs"),COLLAPSE_ALL="codefolding.collapse.all",COLLAPSE="codefolding.collapse",EXPAND="codefolding.expand",EXPAND_ALL="codefolding.expand.all",GUTTER_NAME="CodeMirror-foldgutter",codeFoldingMenuDivider="codefolding.divider",collapseKey="Ctrl-Alt-[",expandKey="Ctrl-Alt-]",collapseAllKey="Alt-1",expandAllKey="Shift-Alt-1";ExtensionUtils.loadStyleSheet(module,"main.less");brackets.getModule(["thirdparty/CodeMirror2/addon/fold/brace-fold"]);brackets.getModule(["thirdparty/CodeMirror2/addon/fold/comment-fold"]);brackets.getModule(["thirdparty/CodeMirror2/addon/fold/markdown-fold"]);var foldGutter=require("foldhelpers/foldgutter"),foldCode=require("foldhelpers/foldcode"),indentFold=require("foldhelpers/indentFold");var _isInitialized=false;function restoreLineFolds(editor){var saveFolds=prefs.getSetting("saveFoldStates");if(!editor||!saveFolds){return}var cm=editor._codeMirror;var path=editor.document.file.fullPath;var folds=cm._lineFolds||prefs.getFolds(path);cm._lineFolds=cm.getValidFolds(folds);prefs.setFolds(path,cm._lineFolds);Object.keys(cm._lineFolds).forEach(function(line){cm.foldCode(Number(line))})}function saveLineFolds(editor){var saveFolds=prefs.getSetting("saveFoldStates");if(!editor||!saveFolds){return}var folds=editor._codeMirror._lineFolds||{};var path=editor.document.file.fullPath;if(Object.keys(folds).length){prefs.setFolds(path,folds)}else{prefs.setFolds(path,undefined)}}function onGutterClick(cm,line,gutter,event){var opts=cm.state.foldGutter.options,pos=CodeMirror.Pos(line);if(gutter!==opts.gutter){return}var range;var _lineFolds=cm._lineFolds;if(cm.isFolded(line)){if(event.altKey){range=_lineFolds[line];CodeMirror.commands.unfoldAll(cm,range.from.line,range.to.line)}else{cm.unfoldCode(line,{range:_lineFolds[line]})}}else{if(event.altKey){range=CodeMirror.fold.auto(cm,pos);if(range){CodeMirror.commands.foldToLevel(cm,range.from.line,range.to.line)}}else{cm.foldCode(line)}}}function collapseCurrent(){var editor=EditorManager.getFocusedEditor();if(!editor){return}var cm=editor._codeMirror;var cursor=editor.getCursorPos(),i;for(i=cursor.line;i>=0;i--){if(cm.foldCode(i)){editor.setCursorPos(i);return}}}function expandCurrent(){var editor=EditorManager.getFocusedEditor();if(editor){var cursor=editor.getCursorPos(),cm=editor._codeMirror;cm.unfoldCode(cursor.line)}}function collapseAll(){var editor=EditorManager.getFocusedEditor();if(editor){var cm=editor._codeMirror;CodeMirror.commands.foldToLevel(cm)}}function expandAll(){var editor=EditorManager.getFocusedEditor();if(editor){var cm=editor._codeMirror;CodeMirror.commands.unfoldAll(cm)}}function createGutter(editor){var cm=editor._codeMirror;var path=editor.document.file.fullPath,_lineFolds=prefs.getFolds(path);_lineFolds=_lineFolds||{};cm._lineFolds=_lineFolds;var gutters=cm.getOption("gutters").slice(0);if(gutters.indexOf(GUTTER_NAME)<0){var lnIndex=gutters.indexOf("CodeMirror-linenumbers");$(editor.getRootElement()).addClass("folding-enabled");gutters.splice(lnIndex+1,0,GUTTER_NAME);cm.setOption("gutters",gutters);cm.refresh()}cm.setOption("foldGutter",{onGutterClick:onGutterClick});$(cm.getGutterElement()).on({mouseenter:function(){if(prefs.getSetting("hideUntilMouseover")){foldGutter.updateInViewport(cm)}else{$(editor.getRootElement()).addClass("over-gutter")}},mouseleave:function(){if(prefs.getSetting("hideUntilMouseover")){foldGutter.clearGutter(cm)}else{$(editor.getRootElement()).removeClass("over-gutter")}}})}function removeGutter(editor){var cm=editor._codeMirror;var gutters=cm.getOption("gutters").slice(0);var index=gutters.indexOf(GUTTER_NAME);$(editor.getRootElement()).removeClass("folding-enabled");gutters.splice(index,1);cm.setOption("gutters",gutters);cm.refresh();CodeMirror.defineOption("foldGutter",false,null)}function enableFoldingInEditor(editor){if(editor._codeMirror.getOption("gutters").indexOf(GUTTER_NAME)===-1){createGutter(editor);restoreLineFolds(editor)}}function onActiveEditorChanged(event,current,previous){if(current){enableFoldingInEditor(current)}if(previous){saveLineFolds(previous)}}function saveBeforeClose(){saveLineFolds(EditorManager.getActiveEditor())}function deinit(){_isInitialized=false;KeyBindingManager.removeBinding(collapseKey);KeyBindingManager.removeBinding(expandKey);KeyBindingManager.removeBinding(collapseAllKey);KeyBindingManager.removeBinding(expandAllKey);Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).removeMenuDivider(codeFoldingMenuDivider.id);Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).removeMenuItem(COLLAPSE);Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).removeMenuItem(EXPAND);Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).removeMenuItem(COLLAPSE_ALL);Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).removeMenuItem(EXPAND_ALL);EditorManager.off(".CodeFolding");DocumentManager.off(".CodeFolding");ProjectManager.off(".CodeFolding");Editor.forEveryEditor(function(editor){CodeMirror.commands.unfoldAll(editor._codeMirror);removeGutter(editor)})}function init(){_isInitialized=true;foldCode.init();foldGutter.init();CodeMirror.registerGlobalHelper("fold","indent",function(mode,cm){return prefs.getSetting("alwaysUseIndentFold")},indentFold);CodeMirror.registerHelper("fold","django",CodeMirror.helpers.fold.brace);CodeMirror.registerHelper("fold","tornado",CodeMirror.helpers.fold.brace);EditorManager.on("activeEditorChange.CodeFolding",onActiveEditorChanged);DocumentManager.on("documentRefreshed.CodeFolding",function(event,doc){restoreLineFolds(doc._masterEditor)});ProjectManager.on("beforeProjectClose.CodeFolding beforeAppClose.CodeFolding",saveBeforeClose);codeFoldingMenuDivider=Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuDivider();Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(COLLAPSE_ALL);Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(EXPAND_ALL);Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(COLLAPSE);Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(EXPAND);KeyBindingManager.addBinding(COLLAPSE_ALL,collapseAllKey);KeyBindingManager.addBinding(EXPAND_ALL,expandAllKey);KeyBindingManager.addBinding(COLLAPSE,collapseKey);KeyBindingManager.addBinding(EXPAND,expandKey);Editor.forEveryEditor(function(editor){enableFoldingInEditor(editor)})}function watchPrefsForChanges(){prefs.prefsObject.on("change",function(e,data){if(data.ids.indexOf("enabled")>-1){var isEnabled=prefs.getSetting("enabled");if(isEnabled&&!_isInitialized){init()}else if(!isEnabled&&_isInitialized){deinit()}}})}AppInit.htmlReady(function(){CommandManager.register(Strings.COLLAPSE_ALL,COLLAPSE_ALL,collapseAll);CommandManager.register(Strings.EXPAND_ALL,EXPAND_ALL,expandAll);CommandManager.register(Strings.COLLAPSE_CURRENT,COLLAPSE,collapseCurrent);CommandManager.register(Strings.EXPAND_CURRENT,EXPAND,expandCurrent);if(prefs.getSetting("enabled")){init()}watchPrefsForChanges()})});